<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline des T√¢ches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        #app-container {
            width: 100%;
            position: relative;
        }
        #task-column::-webkit-scrollbar { width: 8px; }
        #task-column::-webkit-scrollbar-track { background: #2d3748; }
        #task-column::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        #task-column::-webkit-scrollbar-thumb:hover { background: #718096; }
        .hour-marker { height: calc(100% / 24); }
        .task-name-editable { cursor: text; outline: none; }
        .task-name-editable:focus { box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); border-radius: 3px; }
        .progress-bar-container { margin-top: 8px; height: 20px; background-color: rgba(0,0,0,0.2); border-radius: 4px; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background-color: rgba(255, 255, 0, 0.6); border-radius: 4px; transition: width 0.5s ease-in-out; }
        .progress-time-remaining { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.5); }
        #load-menu { position: fixed; top: 10px; right: 10px; z-index: 50; background-color: #1f2937; padding: 8px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #load-menu-toggle { background-color: #374151; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; border: none; }
        #load-menu-content { margin-top: 8px; padding: 12px; background-color: #2d3748; border-radius: 6px; width: 300px; }
        .ai-button { margin-top: 8px; background-color: #8b5cf6; color: white; padding: 6px 10px; border-radius: 6px; cursor: pointer; border: none; width: 100%; text-align: left; display: flex; align-items: center; }
        .ai-button:hover { background-color: #7c3aed; }
        .ai-button .icon { margin-right: 8px; }
        .menu-button { background-color: #4b5563; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; border: none; white-space: nowrap; }
        .menu-button:hover { background-color: #6b7280; }
        #ai-status { margin-top: 8px; padding: 6px; background-color: rgba(255, 255, 0, 0.2); color: #fef08a; border-radius: 4px; font-size: 0.8rem; text-align: center; }
        .hidden { display: none !important; }
        .task-time-range { font-size: 0.75rem; opacity: 0.7; margin-top: 2px; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-box { background-color: #1f2937; padding: 24px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); position: relative; }
        .modal-close-button { position: absolute; top: 12px; right: 12px; background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; }
        .modal-close-button:hover { color: white; }
        #schedule-list { max-height: 150px; overflow-y: auto; background-color: #1f2937; border-radius: 4px; padding: 4px; }
        .schedule-item { display: flex; justify-content: space-between; align-items: center; padding: 6px; border-bottom: 1px solid #374151; }
        .schedule-item:last-child { border-bottom: none; }
        .schedule-item.active { background-color: #4b5563; }
        .schedule-name { cursor: pointer; flex-grow: 1; }
        .schedule-actions button { background: none; border: none; color: #9ca3af; cursor: pointer; padding: 4px; }
        .schedule-actions button:hover { color: white; }
        .input-group { display: flex; gap: 8px; margin-top: 8px; align-items: center; }
        .input-group input { flex-grow: 1; background-color: #4b5563; border: 1px solid #6b7280; color: white; padding: 8px; border-radius: 6px; min-width: 0; }
        
        /* Nouveaux styles pour l'application */
        #auth-overlay { position: fixed; inset: 0; background-color: #111827; z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .auth-card { background-color: #1f2937; padding: 2rem; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); width: 100%; max-width: 400px; }
        .auth-input { width: 100%; background-color: #374151; border: 1px solid #4b5563; color: white; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; outline: none; }
        .auth-input:focus { border-color: #6366f1; ring: 2px; ring-color: #6366f1; }
        .auth-button { width: 100%; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .auth-button-primary { background-color: #4f46e5; color: white; }
        .auth-button-primary:hover { background-color: #4338ca; }
        .auth-button-secondary { background-color: transparent; color: #9ca3af; margin-top: 1rem; }
        .auth-button-secondary:hover { color: white; }
        
        #active-schedule-banner { position: fixed; top: 60px; right: 10px; z-index: 40; background-color: rgba(31, 41, 55, 0.9); backdrop-filter: blur(8px); padding: 12px 20px; border-radius: 12px; border-left: 5px solid #8b5cf6; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); min-width: 200px; text-align: right; }
        #active-schedule-name-display { outline: none; cursor: text; }
        #active-schedule-name-display:focus { color: #a78bfa; }
        #user-profile-btn { background-color: #374151; color: white; padding: 6px; border-radius: 6px; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        #user-profile-btn:hover { background-color: #4b5563; }
        #profile-section { background-color: #374151; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        
        /* Animation pour le statut de synchro */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sync-spinner { animation: spin 1s linear infinite; display: inline-block; }
        .sync-success { color: #4ade80; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- √âcran d'authentification (visible par d√©faut si non connect√©) -->
    <div id="auth-overlay">
        <div class="auth-card">
            <div id="login-form">
                <h2 class="text-2xl font-bold mb-6 text-center">Connexion</h2>
                <input type="email" id="login-email" placeholder="Email" class="auth-input">
                <input type="password" id="login-password" placeholder="Mot de passe" class="auth-input">
                <button id="login-submit" class="auth-button auth-button-primary">Se connecter</button>
                <button id="show-signup" class="auth-button auth-button-secondary">Pas de compte ? S'inscrire</button>
            </div>
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold mb-6 text-center">Cr√©er un compte</h2>
                <input type="email" id="signup-email" placeholder="Email" class="auth-input">
                <input type="password" id="signup-password" placeholder="Mot de passe" class="auth-input">
                <input type="password" id="signup-password-confirm" placeholder="Confirmer le mot de passe" class="auth-input">
                <div id="password-strength-msg" class="text-xs mb-4 text-gray-400"></div>
                <button id="signup-submit" class="auth-button auth-button-primary">S'inscrire</button>
                <button id="show-login" class="auth-button auth-button-secondary">D√©j√† un compte ? Se connecter</button>
            </div>
            <div id="auth-error" class="text-red-400 text-sm mt-4 text-center"></div>
        </div>
    </div>

    <div id="active-schedule-banner" class="hidden">
        <div class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mb-1">Horaire Actuel</div>
        <div class="flex items-center justify-end gap-2">
            <div id="active-schedule-name-display" class="text-2xl font-black text-purple-400 leading-tight" contenteditable="true">---</div>
            <div id="sync-status-icon" class="text-lg" title="Statut de synchronisation"></div>
        </div>
    </div>

    <div id="load-menu" class="hidden">
        <button id="load-menu-toggle">‚ò∞ Menu</button>
        
        <div id="load-menu-content" class="hidden">
            <div class="flex justify-between items-center mb-4 border-b border-gray-600 pb-2">
                <h3 class="font-bold text-xl text-white">MENU</h3>
                <button id="user-profile-btn" title="Mon Compte" class="bg-gray-700 hover:bg-gray-600 p-2 rounded text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                    </svg>
                </button>
            </div>

            <div id="profile-section" class="hidden mb-4 bg-gray-800 p-2 rounded">
                <p id="user-email-display" class="text-sm font-medium text-gray-200 mb-2 truncate"></p>
                <button id="logout-button" class="menu-button w-full text-sm bg-red-600 hover:bg-red-700">D√©connexion</button>
            </div>

            <h4 class="font-bold text-lg mb-2">Gestion des horaires</h4>
            
            <!-- Sous-section: Horaire Actuelle -->
            <div class="bg-gray-800 p-3 rounded mb-4 border border-gray-600">
                <div class="text-xs text-gray-400 uppercase mb-2 font-bold">Horaire Actuelle</div>
                <div class="font-bold text-purple-400 mb-3 truncate text-lg" id="menu-active-schedule-name">---</div>
                <div class="flex justify-between gap-1 mb-1">
                    <button id="btn-rename-current" class="menu-button flex-1 flex justify-center" title="Renommer">‚úèÔ∏è</button>
                    <button id="btn-save-as-current" class="menu-button flex-1 flex justify-center" title="Enregistrer sous...">üíæ</button>
                    <button id="btn-export-current" class="menu-button flex-1 flex justify-center" title="Exporter">üì§</button>
                    <button id="btn-import-new" class="menu-button flex-1 flex justify-center" title="Importer">üì•</button>
                    <button id="btn-delete-current" class="menu-button flex-1 flex justify-center hover:bg-red-900" title="Supprimer">üóëÔ∏è</button>
                </div>
                <input type="file" id="file-importer" class="hidden" accept=".json">
                <input type="hidden" id="schedule-name-input"> <!-- Gard√© pour compatibilit√© JS existant -->
            </div>

            <!-- Sous-section: Autres Horaires -->
            <div class="mb-4">
                <div class="text-xs text-gray-400 uppercase mb-2 font-bold">Autres Horaires</div>
                <div id="other-schedules-list" class="flex flex-col gap-1 max-h-40 overflow-y-auto"></div>
            </div>
            
            <div id="load-error-message" class="text-red-400 text-xs mt-2"></div>
            
            <hr class="my-3 border-gray-600">

            <h4 class="font-bold text-lg mb-2">Assistance IA</h4>
            <button id="create-schedule-ai" class="ai-button"><span class="icon">‚ú®</span> Cr√©er un horaire</button>
            <button id="modify-schedule-ai" class="ai-button"><span class="icon">‚úçÔ∏è</span> Modifier cet horaire</button>
            <div id="ai-status" class="hidden"></div>

            <hr class="my-3 border-gray-600">

            <div class="flex justify-between items-center mb-2">
                <h4 class="font-bold text-lg">√âditer JSON</h4>
                <button id="toggle-json-editor" class="text-xs text-purple-400 hover:text-purple-300">Afficher/Masquer</button>
            </div>
            <div id="json-editor-container" class="hidden">
                <textarea id="json-input" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="8"></textarea>
            </div>
        </div>
    </div>

    <div id="input-choice-modal" class="modal-overlay hidden">
        <div class="modal-box">
            <button id="choice-close-button" class="modal-close-button">&times;</button>
            <h3 class="text-lg font-bold mb-6 text-white text-center">Comment voulez-vous proc√©der ?</h3>
            <div class="flex justify-around gap-4">
                <button id="choice-dictate" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M8 8a3 3 0 0 0-3-3V3a3 3 0 0 0 6 0v2a3 3 0 0 0-3 3z"/></svg> Dicter</button>
                <button id="choice-write" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.44.854a1.531 1.531 0 0 1 2.163 2.162l-8 8a.5.5 0 0 1-.354.146H5.5a.5.5 0 0 1-.5-.5V8.854a.5.5 0 0 1 .146-.353l8-8zM11.5 5.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/><path d="M9.06 11.543l.913-.913 1.132 1.132-.913.913a.5.5 0 0 1-.707 0l-.425-.425a.5.5 0 0 1 0-.707zM10.5 7.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zM2 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2.5a.5.5 0 0 1 1 0V12a3 3 0 0 1-3 3H2a3 3 0 0 1-3-3V4a3 3 0 0 1 3-3h2.5a.5.5 0 0 1 0 1H2z"/></svg> √âcrire</button>
            </div>
        </div>
    </div>
    <div id="text-prompt-modal" class="modal-overlay hidden">
        <div class="modal-box w-11/12 md:w-1/2 lg:w-1/3">
             <button id="text-prompt-close-button" class="modal-close-button">&times;</button>
            <h3 class="text-lg font-bold mb-4 text-white">Entrez votre demande :</h3>
            <textarea id="text-prompt-input" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" rows="4"></textarea>
            <div class="flex justify-end mt-4">
                <button id="text-prompt-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2">Annuler</button>
                <button id="text-prompt-submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">Valider</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex">
        <div id="hour-column" class="w-24 lg:w-28 h-full flex flex-col shrink-0 shadow-lg relative z-[2]"></div>
        <svg id="connectors-svg" class="absolute top-0 left-0 w-full h-full pointer-events-none z-[1]"></svg>
        <div id="task-column" class="flex-grow h-full overflow-y-auto p-3 md:p-4 relative z-[3] ml-12"></div>
    </div>

    <script>
        // --- Configuration Supabase ---
        const SUPABASE_URL = 'https://lnceokgueajzjmhmupwc.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_Iw-62vNCRJ9NUsHvBewLKQ_lfnfth5t';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const SCHEDULE_LIBRARY_KEY = 'timelineAppScheduleLibrary';
        const LAST_ACTIVE_KEY = 'timelineAppLastActiveSchedule';

        let scheduleLibrary = {};
        let activeScheduleName = '';
        let tasks = []; 

        const DEFAULT_SCHEDULE = {
            "Routine Quotidienne": [
                { "start": "06:30", "end": "07:30", "name": "R√©veil & Pr√©paration enfants", "icon": "‚òï" },
                { "start": "07:30", "end": "08:30", "name": "Trajet & D√©pose √©cole", "icon": "üöó" },
                { "start": "08:30", "end": "12:00", "name": "Travail - Bloc Matin", "icon": "üíª" },
                { "start": "12:00", "end": "13:00", "name": "Pause D√©jeuner", "icon": "ü•™" },
                { "start": "13:00", "end": "17:00", "name": "Travail - Bloc Apr√®s-midi", "icon": "üìû" },
                { "start": "17:00", "end": "18:00", "name": "Trajet & R√©cup√©ration enfants", "icon": "üè´" },
                { "start": "18:00", "end": "19:30", "name": "Temps Famille & Devoirs", "icon": "üß∏" },
                { "start": "19:30", "end": "21:00", "name": "D√Æner & Rangement", "icon": "üçΩÔ∏è" },
                { "start": "21:00", "end": "22:30", "name": "Relaxation & Loisirs", "icon": "üìñ" },
                { "start": "22:30", "end": "23:59", "name": "Sommeil", "icon": "üò¥" }
            ]
        };

        const DEFAULT_COLORS = [ "#3498db", "#2ecc71", "#e74c3c", "#9b59b6", "#f1c40f", "#1abc9c", "#d35400", "#34495e", "#7f8c8d", "#27ae60" ];
        const PIXELS_PER_HOUR_TASKS = 80;
        const MIN_TASK_HEIGHT_FOR_DURATION = 40;
        const CONNECTOR_BULGE_FACTOR = 0.4;
        const SHAPE_OPACITY = 0.9;
        const TIME_UPDATE_INTERVAL = 10 * 1000;
        const AUTO_SCROLL_DELAY = 60 * 1000;
        const INITIAL_AUTO_SCROLL_DELAY = 10 * 1000;

        const appContainer = document.getElementById('app-container');
        const hourColumn = document.getElementById('hour-column');
        const taskColumn = document.getElementById('task-column');
        const connectorsSvg = document.getElementById('connectors-svg');
        const loadMenu = document.getElementById('load-menu');
        const loadMenuToggle = document.getElementById('load-menu-toggle');
        const loadMenuContent = document.getElementById('load-menu-content');
        const otherSchedulesList = document.getElementById('other-schedules-list');
        const menuActiveScheduleName = document.getElementById('menu-active-schedule-name');
        const syncStatusIcon = document.getElementById('sync-status-icon');
        
        const btnRenameCurrent = document.getElementById('btn-rename-current');
        const btnSaveAsCurrent = document.getElementById('btn-save-as-current');
        const btnExportCurrent = document.getElementById('btn-export-current');
        const btnImportNew = document.getElementById('btn-import-new');
        const btnDeleteCurrent = document.getElementById('btn-delete-current');

        const scheduleNameInput = document.getElementById('schedule-name-input');
        const fileImporter = document.getElementById('file-importer');
        const loadErrorMessage = document.getElementById('load-error-message');
        const createScheduleAiBtn = document.getElementById('create-schedule-ai');
        const modifyScheduleAiBtn = document.getElementById('modify-schedule-ai');
        const aiStatus = document.getElementById('ai-status');
        const inputChoiceModal = document.getElementById('input-choice-modal');
        const textPromptModal = document.getElementById('text-prompt-modal');
        const choiceDictateBtn = document.getElementById('choice-dictate');
        const choiceWriteBtn = document.getElementById('choice-write');
        const choiceCloseBtn = document.getElementById('choice-close-button');
        const textPromptInput = document.getElementById('text-prompt-input');
        const textPromptSubmitBtn = document.getElementById('text-prompt-submit');
        const textPromptCancelBtn = document.getElementById('text-prompt-cancel');
        const textPromptCloseBtn = document.getElementById('text-prompt-close-button');

        const jsonInput = document.getElementById('json-input');
        // Boutons JSON supprim√©s
        const toggleJsonEditorBtn = document.getElementById('toggle-json-editor');
        const jsonEditorContainer = document.getElementById('json-editor-container');

        const authOverlay = document.getElementById('auth-overlay');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const signupEmailInput = document.getElementById('signup-email');
        const signupPasswordInput = document.getElementById('signup-password');
        const signupPasswordConfirmInput = document.getElementById('signup-password-confirm');
        const loginSubmitBtn = document.getElementById('login-submit');
        const signupSubmitBtn = document.getElementById('signup-submit');
        const showSignupBtn = document.getElementById('show-signup');
        const showLoginBtn = document.getElementById('show-login');
        const authErrorMsg = document.getElementById('auth-error');
        const passwordStrengthMsg = document.getElementById('password-strength-msg');

        const userProfileBtn = document.getElementById('user-profile-btn');
        const profileSection = document.getElementById('profile-section');
        const logoutButton = document.getElementById('logout-button');
        const userEmailDisplay = document.getElementById('user-email-display');
        const activeScheduleBanner = document.getElementById('active-schedule-banner');
        const activeScheduleNameDisplay = document.getElementById('active-schedule-name-display');

        let timeUpdateIntervalId = null;
        let nextTaskId = 1; 
        let autoScrollTimerId = null; 
        let initialAutoScrollTimerId = null;
        let currentAiActionType = '';
        
        // Variables pour l'auto-save
        let localSaveTimer = null;
        let cloudSaveTimer = null;
        let isSyncing = false;

        // --- Fonctions Supabase ---
        async function updateAuthState(session) {
            console.log("Mise √† jour de l'√©tat d'authentification...", session ? "Connect√©" : "D√©connect√©");
            try {
                if (session) {
                    if (authOverlay) authOverlay.classList.add('hidden');
                    if (loadMenu) loadMenu.classList.remove('hidden');
                    if (activeScheduleBanner) activeScheduleBanner.classList.remove('hidden');
                    if (userEmailDisplay) userEmailDisplay.textContent = session.user.email;
                    
                    // On ne bloque pas l'UI pour le chargement des donn√©es
                    fetchSchedulesFromSupabase().catch(err => console.error("Erreur lors du chargement des horaires:", err));
                } else {
                    if (authOverlay) authOverlay.classList.remove('hidden');
                    if (loadMenu) loadMenu.classList.add('hidden');
                    if (activeScheduleBanner) activeScheduleBanner.classList.add('hidden');
                    if (userEmailDisplay) userEmailDisplay.textContent = '';
                    loadLibraryFromStorage();
                }
            } catch (err) {
                console.error("Erreur dans updateAuthState:", err);
            }
        }

        async function handleSignUp() {
            const email = signupEmailInput.value;
            const password = signupPasswordInput.value;
            const confirm = signupPasswordConfirmInput.value;

            if (!email || !password) {
                authErrorMsg.textContent = "Veuillez remplir tous les champs.";
                return;
            }

            if (password !== confirm) {
                authErrorMsg.textContent = "Les mots de passe ne correspondent pas.";
                return;
            }

            if (password.length < 6) {
                authErrorMsg.textContent = "Le mot de passe doit contenir au moins 6 caract√®res.";
                return;
            }

            const originalText = signupSubmitBtn.textContent;
            signupSubmitBtn.textContent = "Cr√©ation en cours...";
            signupSubmitBtn.disabled = true;
            authErrorMsg.textContent = "";

            try {
                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) {
                    authErrorMsg.textContent = "Erreur d'inscription: " + error.message;
                    signupSubmitBtn.textContent = originalText;
                    signupSubmitBtn.disabled = false;
                } else {
                    if (data.session) {
                        updateAuthState(data.session);
                    } else {
                        alert("Inscription r√©ussie ! V√©rifiez vos emails pour confirmer.");
                        showLoginForm();
                        signupSubmitBtn.textContent = originalText;
                        signupSubmitBtn.disabled = false;
                    }
                }
            } catch (err) {
                authErrorMsg.textContent = "Une erreur inattendue est survenue.";
                signupSubmitBtn.textContent = originalText;
                signupSubmitBtn.disabled = false;
            }
        }

        async function handleSignIn() {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            if (!email || !password) {
                authErrorMsg.textContent = "Veuillez entrer votre email et mot de passe.";
                return;
            }
            
            const originalText = loginSubmitBtn.textContent;
            loginSubmitBtn.textContent = "Connexion en cours...";
            loginSubmitBtn.disabled = true;
            authErrorMsg.textContent = "";

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    authErrorMsg.textContent = "Erreur de connexion: " + error.message;
                    loginSubmitBtn.textContent = originalText;
                    loginSubmitBtn.disabled = false;
                } else if (data.session) {
                    updateAuthState(data.session);
                }
            } catch (err) {
                authErrorMsg.textContent = "Une erreur inattendue est survenue.";
                loginSubmitBtn.textContent = originalText;
                loginSubmitBtn.disabled = false;
            }
        }

        async function handleSignOut() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) console.error("Erreur d√©connexion:", error);
            
            // Nettoyage complet des traces locales
            scheduleLibrary = {};
            localStorage.removeItem(SCHEDULE_LIBRARY_KEY);
            localStorage.removeItem(LAST_ACTIVE_KEY);
            
            profileSection.classList.add('hidden');
            // On recharge l'app pour revenir √† l'√©tat initial
            window.location.reload();
        }

        function showSignupForm() {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            authErrorMsg.textContent = '';
        }

        function showLoginForm() {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authErrorMsg.textContent = '';
        }

        function toggleProfile() {
            profileSection.classList.toggle('hidden');
        }

        function toggleJsonEditor() {
            jsonEditorContainer.classList.toggle('hidden');
        }

        async function fetchSchedulesFromSupabase() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            const { data, error } = await supabaseClient
                .from('schedules')
                .select('*')
                .order('created_at', { ascending: true });

            if (error) {
                console.error("Erreur fetch Supabase:", error);
                return;
            }

            // On vide TOUJOURS la biblioth√®que locale avant de charger les donn√©es Cloud
            scheduleLibrary = {};

            if (data && data.length > 0) {
                data.forEach(s => {
                    scheduleLibrary[s.name] = s.tasks;
                    if (s.is_active) activeScheduleName = s.name;
                });
                
                if (!activeScheduleName) activeScheduleName = data[0].name;
                loadSchedule(activeScheduleName);
            } else {
                // Si l'utilisateur n'a rien sur le Cloud, on charge l'horaire par d√©faut
                scheduleLibrary = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
                loadSchedule(Object.keys(scheduleLibrary)[0]);
            }
        }

        async function saveScheduleToSupabase(name, tasksToSave) {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            // aiStatus.textContent = "Synchronisation..."; // G√©r√© par l'ic√¥ne maintenant
            // aiStatus.classList.remove('hidden');

            const { error } = await supabaseClient
                .from('schedules')
                .upsert({ 
                    user_id: user.id, 
                    name: name, 
                    tasks: tasksToSave, 
                    is_active: true 
                }, { 
                    onConflict: 'user_id,name' 
                })
                .select()
                .maybeSingle();

            if (error) {
                console.error("Erreur Supabase:", error);
                loadErrorMessage.textContent = "Erreur de synchronisation: " + error.message;
                updateSyncIcon('error');
            } else {
                // aiStatus.textContent = "Sauvegard√© sur le Cloud !";
                // setTimeout(() => aiStatus.classList.add('hidden'), 3000);
                updateSyncIcon('saved');
                // loadSchedule(name); // Pas besoin de recharger tout l'UI si c'est juste une save auto
            }
        }

        const recognition = (window.SpeechRecognition || window.webkitSpeechRecognition) ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
        if (recognition) {
            recognition.lang = 'fr-FR';
            recognition.continuous = false;
            recognition.interimResults = false;
        }
        
        function setAppHeight() {
            appContainer.style.height = `${window.innerHeight}px`;
            requestAnimationFrame(drawUnifiedTaskShapes);
        }

        function initializeTimelineRender() {
            renderHours();
            renderTasks(); 
            requestAnimationFrame(drawUnifiedTaskShapes); 
            updateActiveTaskProgress();
        }

        function updateSyncIcon(status) {
            if (!syncStatusIcon) return;
            syncStatusIcon.className = 'text-lg ml-2'; // Reset classes
            
            if (status === 'pending') {
                syncStatusIcon.innerHTML = 'üîÑ';
                syncStatusIcon.classList.add('sync-spinner');
                syncStatusIcon.title = "Synchronisation en attente...";
                isSyncing = true;
            } else if (status === 'saved') {
                syncStatusIcon.innerHTML = '‚úÖ';
                syncStatusIcon.classList.add('sync-success');
                syncStatusIcon.title = "Sauvegard√© sur le Cloud";
                isSyncing = false;
                // Masquer le check apr√®s quelques secondes
                setTimeout(() => {
                    if (!isSyncing) syncStatusIcon.innerHTML = '';
                }, 5000);
            } else if (status === 'error') {
                syncStatusIcon.innerHTML = '‚ö†Ô∏è';
                syncStatusIcon.classList.add('text-red-500');
                syncStatusIcon.title = "Erreur de synchronisation";
                isSyncing = false;
            } else {
                syncStatusIcon.innerHTML = '';
                isSyncing = false;
            }
        }

        function triggerAutoSave(source) {
            updateSyncIcon('pending');
            
            // Reset timers
            if (localSaveTimer) clearTimeout(localSaveTimer);
            if (cloudSaveTimer) clearTimeout(cloudSaveTimer);

            // 1. Local Save & UI Update (4 secondes)
            localSaveTimer = setTimeout(() => {
                if (source === 'json') {
                    // Si la modif vient du JSON, on met √† jour l'UI
                    try {
                        const jsonContent = jsonInput.value.trim();
                        if (jsonContent && jsonContent !== "[]") {
                            const parsed = JSON.parse(jsonContent);
                            if (validateTaskData(parsed)) {
                                tasks = processTasks(parsed);
                                scheduleLibrary[activeScheduleName] = parsed;
                                initializeTimelineRender();
                            }
                        }
                    } catch (e) { console.error("JSON invalide pendant auto-save", e); }
                } else {
                    // Si la modif vient de l'UI, on met √† jour le JSON et la librairie
                    const scheduleToSave = tasks.map(({ name, start, end, icon }) => ({ name, start, end, icon: icon || undefined }));
                    scheduleLibrary[activeScheduleName] = scheduleToSave;
                    if (!loadMenuContent.classList.contains('hidden')) {
                        jsonInput.value = JSON.stringify(scheduleToSave, null, 2);
                    }
                }
                saveLibraryToStorage();
                console.log("Sauvegarde locale effectu√©e");
            }, 4000);

            // 2. Cloud Save (30 secondes)
            cloudSaveTimer = setTimeout(() => {
                const scheduleToSave = scheduleLibrary[activeScheduleName];
                if (scheduleToSave) {
                    saveScheduleToSupabase(activeScheduleName, scheduleToSave);
                }
            }, 30000);
        }

        function loadSchedule(name) {
            // Protection contre la perte de donn√©es non synchronis√©es
            if (isSyncing && name !== activeScheduleName) {
                if (!confirm(`Des modifications sur "${activeScheduleName}" sont en attente de synchronisation vers le Cloud. Voulez-vous vraiment changer d'horaire maintenant ? (Les modifications locales sont conserv√©es mais pas encore sur le serveur)`)) {
                    return;
                }
            }

            if (!scheduleLibrary[name]) {
                console.error(`Horaire "${name}" non trouv√©.`);
                return;
            }
            activeScheduleName = name;
            localStorage.setItem(LAST_ACTIVE_KEY, name);
            scheduleNameInput.value = name;
            activeScheduleNameDisplay.textContent = name;
            if(menuActiveScheduleName) menuActiveScheduleName.textContent = name;
            
            tasks = processTasks(scheduleLibrary[name]);
            renderOtherSchedulesList();
            initializeTimelineRender();
            
            // Reset sync status on load
            updateSyncIcon('hidden');
            if (localSaveTimer) clearTimeout(localSaveTimer);
            if (cloudSaveTimer) clearTimeout(cloudSaveTimer);
        }

        function saveAsNewSchedule() {
            const newName = prompt("Entrez le nom pour la nouvelle copie de l'horaire :", activeScheduleName + " (copie)");
            if (newName && newName.trim() !== "") {
                if (scheduleLibrary[newName]) {
                    alert("Un horaire avec ce nom existe d√©j√†.");
                    return;
                }
                
                // Copier les donn√©es actuelles
                scheduleLibrary[newName] = JSON.parse(JSON.stringify(scheduleLibrary[activeScheduleName]));
                saveLibraryToStorage();
                
                // Charger le nouvel horaire
                activeScheduleName = newName;
                loadSchedule(newName);
                
                // Sauvegarder imm√©diatement sur Supabase
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        saveScheduleToSupabase(newName, scheduleLibrary[newName]);
                    }
                });
            }
        }

        // Synchroniser le nom √©dit√© dans la banni√®re avec l'input cach√©
        activeScheduleNameDisplay.addEventListener('blur', () => {
            const newName = activeScheduleNameDisplay.textContent.trim();
            if (newName) {
                scheduleNameInput.value = newName;
            } else {
                activeScheduleNameDisplay.textContent = activeScheduleName;
            }
        });

        activeScheduleNameDisplay.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                activeScheduleNameDisplay.blur();
            }
        });

        function renameCurrentSchedule() {
            const newName = prompt("Entrez le nouveau nom pour l'horaire :", activeScheduleName);
            if (newName && newName.trim() !== "" && newName !== activeScheduleName) {
                if (scheduleLibrary[newName]) {
                    alert("Un horaire avec ce nom existe d√©j√†.");
                    return;
                }
                
                // Copier les donn√©es
                scheduleLibrary[newName] = scheduleLibrary[activeScheduleName];
                
                // Supprimer l'ancien (localement)
                const oldName = activeScheduleName;
                delete scheduleLibrary[oldName];
                
                // Sauvegarder le nouveau
                saveLibraryToStorage();
                
                // Mettre √† jour l'√©tat
                activeScheduleName = newName;
                loadSchedule(newName);
                
                // Sync Supabase : Sauvegarder le nouveau, supprimer l'ancien
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        saveScheduleToSupabase(newName, scheduleLibrary[newName]);
                        // Suppression de l'ancien sur Supabase
                        supabaseClient.from('schedules').delete().match({ user_id: session.user.id, name: oldName }).then(({ error }) => {
                            if (error) console.error("Erreur suppression ancien nom:", error);
                        });
                    }
                });
            }
        }

        function renderOtherSchedulesList() {
            otherSchedulesList.innerHTML = '';
            const otherSchedules = Object.keys(scheduleLibrary).filter(name => name !== activeScheduleName);
            
            if (otherSchedules.length === 0) {
                otherSchedulesList.innerHTML = `<div class="text-center text-gray-500 p-2 text-xs italic">Aucun autre horaire.</div>`;
                return;
            }
            
            otherSchedules.forEach(name => {
                const item = document.createElement('div');
                item.className = `flex justify-between items-center bg-gray-700 p-2 rounded hover:bg-gray-600 transition-colors`;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-sm text-gray-200 cursor-pointer flex-grow truncate mr-2';
                nameSpan.textContent = name;
                nameSpan.onclick = () => loadSchedule(name);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-1';

                const exportBtn = document.createElement('button');
                exportBtn.innerHTML = 'üì§';
                exportBtn.className = 'text-xs p-1 hover:text-white text-gray-400';
                exportBtn.title = "Exporter";
                exportBtn.onclick = (e) => { e.stopPropagation(); exportSchedule(name); };

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.className = 'text-xs p-1 hover:text-red-400 text-gray-400';
                deleteBtn.title = "Supprimer";
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteSchedule(name); };

                actionsDiv.appendChild(exportBtn);
                actionsDiv.appendChild(deleteBtn);
                item.appendChild(nameSpan);
                item.appendChild(actionsDiv);
                otherSchedulesList.appendChild(item);
            });
        }

        function saveCurrentSchedule() {
            const name = scheduleNameInput.value.trim();
            if (!name) {
                loadErrorMessage.textContent = "Veuillez donner un nom √† l'horaire.";
                return;
            }

            // On essaie d'abord de r√©cup√©rer les donn√©es du champ JSON si l'utilisateur l'a modifi√©
            let scheduleToSave;
            try {
                const jsonContent = jsonInput.value.trim();
                if (jsonContent && jsonContent !== "[]") {
                    const parsed = JSON.parse(jsonContent);
                    if (validateTaskData(parsed)) {
                        scheduleToSave = parsed.map(({ name, start, end, icon }) => ({ name, start, end, icon: icon || undefined }));
                    }
                }
            } catch (e) {
                // Si le JSON est invalide, on utilise les t√¢ches actuelles de l'√©cran
            }

            if (!scheduleToSave) {
                scheduleToSave = tasks.map(({ name, start, end, icon }) => ({ name, start, end, icon: icon || undefined }));
            }
            
            scheduleLibrary[name] = scheduleToSave;
            saveLibraryToStorage();
            
            // Sync avec Supabase si connect√©
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    saveScheduleToSupabase(name, scheduleToSave);
                } else {
                    loadSchedule(name);
                }
            });
        }

        function deleteSchedule(name) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'horaire "${name}" ?`)) {
                delete scheduleLibrary[name];
                saveLibraryToStorage();
                
                // Suppression Supabase
                supabaseClient.auth.getSession().then(({ data: { session } }) => {
                    if (session) {
                        supabaseClient.from('schedules').delete().match({ user_id: session.user.id, name: name }).then();
                    }
                });
                
                if (activeScheduleName === name) {
                    const remainingSchedules = Object.keys(scheduleLibrary);
                    if (remainingSchedules.length > 0) {
                        loadSchedule(remainingSchedules[0]);
                    } else {
                        scheduleLibrary = { ...DEFAULT_SCHEDULE };
                        loadSchedule(Object.keys(scheduleLibrary)[0]);
                    }
                } else {
                    renderOtherSchedulesList();
                }
            }
        }

        function exportSchedule(name) {
            const scheduleData = scheduleLibrary[name];
            if (!scheduleData) return;
            const jsonString = JSON.stringify(scheduleData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name.replace(/ /g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    if (validateTaskData(jsonData)) {
                        let scheduleName = file.name.replace('.json', '');
                        let counter = 1;
                        while(scheduleLibrary[scheduleName]) {
                            scheduleName = `${file.name.replace('.json', '')}_${counter++}`;
                        }
                        scheduleLibrary[scheduleName] = jsonData;
                        saveLibraryToStorage();
                        
                        // Sync Supabase
                        supabaseClient.auth.getSession().then(({ data: { session } }) => {
                            if (session) {
                                saveScheduleToSupabase(scheduleName, jsonData);
                            }
                        });

                        loadSchedule(scheduleName);
                    } else {
                        loadErrorMessage.textContent = "Fichier JSON invalide.";
                    }
                } catch (error) {
                    loadErrorMessage.textContent = "Erreur de lecture du fichier.";
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function loadLibraryFromStorage() {
            const savedLibraryJSON = localStorage.getItem(SCHEDULE_LIBRARY_KEY);
            if (savedLibraryJSON) {
                try {
                    scheduleLibrary = JSON.parse(savedLibraryJSON);
                    // Ensure it's an object and not empty, and that at least one schedule has tasks
                    const hasTasks = Object.values(scheduleLibrary).some(s => Array.isArray(s) && s.length > 0);
                    if (!scheduleLibrary || typeof scheduleLibrary !== 'object' || Object.keys(scheduleLibrary).length === 0 || !hasTasks) {
                        scheduleLibrary = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
                    }
                } catch (e) {
                    console.error("Erreur de chargement de la librairie", e);
                    scheduleLibrary = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
                }
            } else {
                scheduleLibrary = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
            }
        }

        function saveLibraryToStorage() {
            localStorage.setItem(SCHEDULE_LIBRARY_KEY, JSON.stringify(scheduleLibrary));
        }

        function renderScheduleList() {
            // Fonction obsol√®te remplac√©e par renderOtherSchedulesList
            renderOtherSchedulesList();
        }
        
        function parseHHMMToDecimal(timeStr) {
            if (typeof timeStr !== 'string') return 0;
            const parts = timeStr.split(':');
            if (parts.length !== 2) return 0;
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            if (isNaN(hours) || isNaN(minutes)) return 0;
            return hours + minutes / 60;
        }

        function formatHour(hour) {
            const h = Math.floor(hour) % 24;
            return h.toString().padStart(2, '0') + ':00';
        }
        
        function formatTimeToHHMMForTaskBlock(decimalHour, isEndDate) {
            const totalMinutes = Math.round(decimalHour * 60);
            let hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            if (isEndDate && hours === 24 && minutes === 0) return "24:00";
            if (isEndDate && hours > 24 && (hours % 24 === 0) && minutes === 0) return "24:00";
            const displayHours = hours % 24;
            return `${displayHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function formatTimeRemaining(totalMinutes) {
            if (totalMinutes <= 0) return "Termin√©";
            const hours = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            let str = "";
            if (hours > 0) str += `${hours}h `;
            str += `${minutes}min`;
            return str + " rest.";
        }
        
        function formatDuration(startDecimal, endDecimal) {
            const durationTotalMinutes = Math.round((endDecimal - startDecimal) * 60);
            if (durationTotalMinutes <= 0) return "0min";
            const hours = Math.floor(durationTotalMinutes / 60);
            const minutes = durationTotalMinutes % 60;
            let durationStr = "";
            if (hours > 0) durationStr += `${hours}hr`;
            if (minutes > 0) durationStr += ` ${minutes}min`;
            return durationStr.trim() || "0min";
        }
        
        function processTasks(sourceTasksArray) {
            nextTaskId = 1; 
            return sourceTasksArray
                .map((task, index) => {
                    const startDecimal = parseHHMMToDecimal(task.start);
                    const endDecimal = parseHHMMToDecimal(task.end);
                    if (startDecimal >= 24) return null; 
                    
                    return { 
                        ...task, 
                        id: nextTaskId++, 
                        color: DEFAULT_COLORS[index % DEFAULT_COLORS.length], 
                        startDecimal, 
                        endDecimal 
                    };
                })
                .filter(task => task !== null);
        }
        
        function renderHours() {
            hourColumn.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const hourMarker = document.createElement('div');
                hourMarker.classList.add('hour-marker', 'flex', 'items-center', 'justify-center', 'text-xs', 'text-gray-100', 'border-b', 'border-gray-700/50');
                if (i === 23) hourMarker.classList.remove('border-b');
                hourMarker.textContent = formatHour(i);
                hourColumn.appendChild(hourMarker);
            }
        }

        function renderTasks() {
            taskColumn.innerHTML = '';
            const sortedTasks = [...tasks].sort((a, b) => a.startDecimal - b.startDecimal);
            sortedTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.id = `task-${task.id}`;
                taskElement.classList.add('task-item-block', 'mb-1', 'p-2', 'md:p-3', 'rounded-lg', 'shadow-md', 'text-white', 'flex', 'flex-col', 'justify-center');
                
                const durationHours = task.endDecimal - task.startDecimal;
                const durationBasedMinHeight = Math.max(MIN_TASK_HEIGHT_FOR_DURATION, durationHours * PIXELS_PER_HOUR_TASKS);
                taskElement.style.minHeight = `${durationBasedMinHeight}px`;

                const nameElement = document.createElement('div');
                nameElement.classList.add('task-name-editable', 'font-semibold', 'text-sm', 'md:text-base');
                nameElement.textContent = task.name;
                nameElement.contentEditable = "true";

                nameElement.addEventListener('blur', (event) => {
                    const currentNameElement = event.target;
                    const currentTaskElement = currentNameElement.closest('.task-item-block');
                    if (!currentTaskElement) return;
                    const taskIdNumeric = parseInt(currentTaskElement.id.split('-')[1]);
                    
                    const taskToUpdateInTasks = tasks.find(t => t.id === taskIdNumeric); 
                    if (taskToUpdateInTasks && taskToUpdateInTasks.name !== currentNameElement.textContent) {
                        taskToUpdateInTasks.name = currentNameElement.textContent;
                        triggerAutoSave('ui'); // D√©clenche l'auto-save
                    }
                });
                nameElement.addEventListener('input', () => {
                     requestAnimationFrame(drawUnifiedTaskShapes);
                     // On pourrait d√©clencher l'auto-save ici aussi, mais 'blur' est plus s√ªr pour √©viter trop d'appels
                     // triggerAutoSave('ui'); 
                });
                
                nameElement.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        event.target.blur();
                    }
                });

                const timeRangeElement = document.createElement('div');
                timeRangeElement.classList.add('task-time-range');
                timeRangeElement.textContent = `${formatTimeToHHMMForTaskBlock(task.startDecimal)} - ${formatTimeToHHMMForTaskBlock(task.endDecimal, true)}`;

                const durationElement = document.createElement('div');
                durationElement.classList.add('text-xs', 'md:text-sm', 'opacity-80');
                durationElement.textContent = formatDuration(task.startDecimal, task.endDecimal);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.classList.add('task-content-wrapper');
                if (task.icon) {
                    const iconElement = document.createElement('span');
                    iconElement.classList.add('mr-2', 'text-lg', 'float-left');
                    iconElement.textContent = task.icon;
                    contentWrapper.appendChild(iconElement);
                }
                contentWrapper.appendChild(nameElement);
                contentWrapper.appendChild(timeRangeElement);
                contentWrapper.appendChild(durationElement);
                
                taskElement.appendChild(contentWrapper);
                taskColumn.appendChild(taskElement);
            });
        }

        function updateActiveTaskProgress() {
            const now = new Date();
            const currentTimeInHours = now.getHours() + now.getMinutes() / 60.0;
            document.querySelectorAll('.progress-bar-container').forEach(bar => bar.remove());

            let activeTask = null;
            for (const task of tasks) { 
                if (currentTimeInHours >= task.startDecimal && currentTimeInHours < task.endDecimal) {
                    activeTask = task;
                    const taskElement = document.getElementById(`task-${task.id}`);
                    if (taskElement) {
                        const taskContentWrapper = taskElement.querySelector('.task-content-wrapper');
                        if (taskContentWrapper) {
                            const totalDurationMinutes = (task.endDecimal - task.startDecimal) * 60;
                            const elapsedMinutes = (currentTimeInHours - task.startDecimal) * 60;
                            const remainingMinutes = totalDurationMinutes - elapsedMinutes;
                            const progressPercentage = Math.min(100, (elapsedMinutes / totalDurationMinutes) * 100);

                            let progressBarContainer = taskElement.querySelector('.progress-bar-container');
                            if (!progressBarContainer) {
                                progressBarContainer = document.createElement('div');
                                progressBarContainer.classList.add('progress-bar-container');
                                const progressBarFill = document.createElement('div');
                                progressBarFill.classList.add('progress-bar-fill');
                                progressBarContainer.appendChild(progressBarFill);
                                const timeRemainingText = document.createElement('div');
                                timeRemainingText.classList.add('progress-time-remaining');
                                progressBarContainer.appendChild(timeRemainingText);
                                taskContentWrapper.parentNode.insertBefore(progressBarContainer, taskContentWrapper.nextSibling);
                            }
                            
                            progressBarContainer.querySelector('.progress-bar-fill').style.width = `${progressPercentage}%`;
                            progressBarContainer.querySelector('.progress-time-remaining').textContent = formatTimeRemaining(remainingMinutes);
                        }
                    }
                    break; 
                }
            }
            requestAnimationFrame(drawUnifiedTaskShapes);
            return activeTask; 
        }
        
        function centerOnActiveTask(forceScroll = false) {
            const now = new Date();
            const currentTimeInHours = now.getHours() + now.getMinutes() / 60.0;
            let activeTaskData = null;
            for (const task of tasks) {
                if (currentTimeInHours >= task.startDecimal && currentTimeInHours < task.endDecimal) {
                    activeTaskData = task;
                    break;
                }
            }

            if (activeTaskData) {
                const activeTaskElement = document.getElementById(`task-${activeTaskData.id}`);
                if (activeTaskElement) {
                    const scrollTop = activeTaskElement.offsetTop - (taskColumn.clientHeight / 2) + (activeTaskElement.offsetHeight / 2);
                    
                    if (forceScroll || Math.abs(taskColumn.scrollTop - scrollTop) > 1) { 
                        taskColumn.scrollTo({
                            top: scrollTop,
                            behavior: 'smooth'
                        });
                    }
                }
            }
        }

        function drawUnifiedTaskShapes() {
            connectorsSvg.innerHTML = '';
            if (!hourColumn.clientHeight || !taskColumn.clientWidth) return;

            const hourColumnRect = hourColumn.getBoundingClientRect();
            const pixelsPerUnitInHourColumn = hourColumn.clientHeight / 24;
            const sortedTasks = [...tasks].sort((a, b) => a.startDecimal - b.startDecimal).reverse(); 

            sortedTasks.forEach(task => {
                const taskElement = document.getElementById(`task-${task.id}`);
                if (!taskElement) return;

                const taskRect = taskElement.getBoundingClientRect();
                const taskTopRelativeToDocument = taskRect.top;
                const taskBottomRelativeToDocument = taskRect.bottom;
                const taskLeftRelativeToDocument = taskRect.left;
                const taskRightRelativeToDocument = taskRect.right;

                let startHourOnScale = task.startDecimal % 24;
                let endHourOnScaleVisual = task.endDecimal;

                if (task.endDecimal - task.startDecimal >= 24) { 
                    startHourOnScale = 0; 
                    endHourOnScaleVisual = 24;
                } else {
                    if (task.endDecimal > 24) {
                        endHourOnScaleVisual = 24;
                    } else {
                        endHourOnScaleVisual = task.endDecimal % 24;
                        if (endHourOnScaleVisual === 0 && task.endDecimal > 0) endHourOnScaleVisual = 24;
                    }
                }

                const yStartHour = startHourOnScale * pixelsPerUnitInHourColumn;
                let yEndHour = endHourOnScaleVisual * pixelsPerUnitInHourColumn;

                if (yEndHour <= yStartHour) {
                    if (endHourOnScaleVisual === 0 && startHourOnScale > 23) {
                        yEndHour = 24 * pixelsPerUnitInHourColumn;
                    } else {
                        yEndHour = yStartHour + (pixelsPerUnitInHourColumn * (1/60));
                    }
                }

                const H_TL = { x: hourColumnRect.left, y: yStartHour };
                const H_TR = { x: hourColumnRect.right, y: yStartHour };
                const T_TL = { x: taskLeftRelativeToDocument, y: taskTopRelativeToDocument };
                const T_TR = { x: taskRightRelativeToDocument, y: taskTopRelativeToDocument };
                const T_BR = { x: taskRightRelativeToDocument, y: taskBottomRelativeToDocument };
                const T_BL = { x: taskLeftRelativeToDocument, y: taskBottomRelativeToDocument };
                const H_BL = { x: hourColumnRect.left, y: yEndHour };
                const H_BR = { x: hourColumnRect.right, y: yEndHour };

                const connectorSpaceWidth = T_TL.x - H_TR.x;
                const bulge = connectorSpaceWidth * CONNECTOR_BULGE_FACTOR;

                const P1_top_ctrl = { x: H_TR.x + bulge, y: H_TR.y };
                const P2_top_ctrl = { x: T_TL.x - bulge, y: T_TL.y };
                const P1_bottom_ctrl = { x: T_BL.x - bulge, y: T_BL.y };
                const P2_bottom_ctrl = { x: H_BR.x + bulge, y: H_BR.y };
                                
                const unifiedPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${H_TL.x} ${H_TL.y} L ${H_TR.x} ${H_TR.y} C ${P1_top_ctrl.x} ${P1_top_ctrl.y}, ${P2_top_ctrl.x} ${P2_top_ctrl.y}, ${T_TL.x} ${T_TL.y} L ${T_TR.x} ${T_TR.y} L ${T_BR.x} ${T_BR.y} L ${T_BL.x} ${T_BL.y} C ${P1_bottom_ctrl.x} ${P1_bottom_ctrl.y}, ${P2_bottom_ctrl.x} ${P2_bottom_ctrl.y}, ${H_BR.x} ${H_BR.y} L ${H_BL.x} ${H_BL.y} Z`;
                unifiedPath.setAttribute('d', d);
                unifiedPath.setAttribute('fill', task.color);
                unifiedPath.style.opacity = String(SHAPE_OPACITY);
                connectorsSvg.appendChild(unifiedPath);
            });
        }
        
        async function generateScheduleWithGemini(userText, promptType) {
            // Fonctionnalit√© d√©sactiv√©e temporairement pour la mise en ligne publique
            // Les cl√©s API seront configur√©es plus tard
            aiStatus.textContent = "Fonctionnalit√© IA √† venir !";
            aiStatus.classList.remove('hidden');
            loadErrorMessage.textContent = '';
            
            console.log("IA demand√©e :", userText, promptType);
            
            setTimeout(() => {
                aiStatus.textContent = "Cette fonctionnalit√© sera bient√¥t disponible.";
                setTimeout(() => aiStatus.classList.add('hidden'), 3000);
            }, 1000);
        }

        function handleSpeechRecognition() {
            if (!recognition) return;
            let resultReceived = false;

            aiStatus.textContent = "Je vous √©coute...";
            aiStatus.classList.remove('hidden');

            recognition.start();

            recognition.onresult = (event) => {
                resultReceived = true;
                const speechResult = event.results[0][0].transcript;
                aiStatus.textContent = `J'ai compris : "${speechResult}". Traitement...`;
                generateScheduleWithGemini(speechResult, currentAiActionType);
            };

            recognition.onerror = (event) => {
                resultReceived = true;
                console.error("Erreur de reconnaissance vocale:", event.error);
                if (event.error === 'not-allowed') {
                    aiStatus.textContent = "Acc√®s au micro refus√©.";
                    loadErrorMessage.textContent = "Veuillez autoriser l'acc√®s au microphone dans les param√®tres de votre fureteur.";
                } else {
                    aiStatus.textContent = `Erreur: ${event.error}`;
                }
            };
            
            recognition.onend = () => {
                if (!resultReceived) {
                    aiStatus.classList.add('hidden');
                }
            }
        }

        function openInputChoiceModal(actionType) {
            currentAiActionType = actionType;
            inputChoiceModal.classList.remove('hidden');
        }

        function closeInputChoiceModal() {
            inputChoiceModal.classList.add('hidden');
        }

        function openTextPromptModal() {
            textPromptInput.value = '';
            textPromptModal.classList.remove('hidden');
            textPromptInput.focus();
        }

        function closeTextPromptModal() {
            textPromptModal.classList.add('hidden');
        }

        function validateTaskData(data) { 
            if (!Array.isArray(data)) return false;
            const timeRegex = /^(?:[01]\d|2[0-3]):[0-5]\d$|^(?:24:00)$/;
            const endTimeRegex = /^(?:\d{1,2}):[0-5]\d$/;

            for (const item of data) {
                if (typeof item.name !== 'string' || typeof item.start !== 'string' || typeof item.end !== 'string') return false;
                if (item.icon !== undefined && typeof item.icon !== 'string') return false;
                if (!timeRegex.test(item.start)) { console.warn("Format HH:MM invalide pour start:", item.start, item); return false; }
                if (!endTimeRegex.test(item.end)) { console.warn("Format HH:MM invalide pour end:", item.end, item); return false; }
                if (parseHHMMToDecimal(item.start) >= parseHHMMToDecimal(item.end)) { console.warn(`T√¢che invalide (start >= end): ${item.name}`, item); return false; }
            }
            return true;
        }

        function handleLoadData() {
            loadErrorMessage.textContent = '';
            aiStatus.classList.add('hidden');
            try {
                const jsonData = JSON.parse(jsonInput.value);
                if (validateTaskData(jsonData)) {
                    if (activeScheduleName && scheduleLibrary[activeScheduleName]) {
                        scheduleLibrary[activeScheduleName] = jsonData;
                        saveLibraryToStorage();
                        tasks = processTasks(jsonData);
                        initializeTimelineRender();
                        loadMenuContent.classList.add('hidden');
                    } else {
                        loadErrorMessage.textContent = "Aucun horaire actif √† mettre √† jour.";
                    }
                } else {
                    loadErrorMessage.textContent = "Format JSON invalide ou donn√©es de t√¢che incorrectes.";
                }
            } catch (error) {
                loadErrorMessage.textContent = "Erreur de parsing JSON: " + error.message;
                console.error("Erreur de parsing JSON:", error);
            }
        }
        
        // --- Initialisation ---
        function initializeApp() {
            setAppHeight();
            loadLibraryFromStorage();

            let lastActive = localStorage.getItem(LAST_ACTIVE_KEY);
            
            // If lastActive is not in library, or library is empty, fallback to first available
            if (!lastActive || !scheduleLibrary[lastActive]) {
                lastActive = Object.keys(scheduleLibrary)[0];
            }

            if (lastActive) {
                loadSchedule(lastActive);
            } else {
                // Extreme fallback
                scheduleLibrary = JSON.parse(JSON.stringify(DEFAULT_SCHEDULE));
                loadSchedule(Object.keys(scheduleLibrary)[0]);
            }

            if (timeUpdateIntervalId) clearInterval(timeUpdateIntervalId);
            timeUpdateIntervalId = setInterval(() => {
                updateActiveTaskProgress(); 
            }, TIME_UPDATE_INTERVAL);

            if(initialAutoScrollTimerId) clearTimeout(initialAutoScrollTimerId);
            initialAutoScrollTimerId = setTimeout(() => {
                centerOnActiveTask(true);
            }, INITIAL_AUTO_SCROLL_DELAY);
        }
        
        // --- √âcouteurs d'√©v√©nements ---
        loadMenuToggle.addEventListener('click', () => {
            const isHidden = loadMenuContent.classList.toggle('hidden');
            aiStatus.classList.add('hidden');
            loadErrorMessage.textContent = '';
            if (!isHidden) { 
                if (activeScheduleName && scheduleLibrary[activeScheduleName]) {
                    jsonInput.value = JSON.stringify(scheduleLibrary[activeScheduleName], null, 2); 
                }
                jsonInput.scrollTop = 0; 
                jsonInput.scrollLeft = 0; 
            }
        });
        
        // Nouveaux √©couteurs pour la gestion des horaires
        btnRenameCurrent.addEventListener('click', renameCurrentSchedule);
        btnSaveAsCurrent.addEventListener('click', saveAsNewSchedule);
        btnExportCurrent.addEventListener('click', () => exportSchedule(activeScheduleName));
        btnImportNew.addEventListener('click', () => fileImporter.click());
        btnDeleteCurrent.addEventListener('click', () => deleteSchedule(activeScheduleName));
        
        fileImporter.addEventListener('change', importFile);

        // √âcouteur pour l'auto-save JSON
        jsonInput.addEventListener('input', () => {
            triggerAutoSave('json');
        });

        createScheduleAiBtn.addEventListener('click', () => openInputChoiceModal('new'));
        modifyScheduleAiBtn.addEventListener('click', () => openInputChoiceModal('modify'));

        choiceDictateBtn.addEventListener('click', () => {
            closeInputChoiceModal();
            handleSpeechRecognition();
        });
        choiceWriteBtn.addEventListener('click', () => {
            closeInputChoiceModal();
            openTextPromptModal();
        });
        choiceCloseBtn.addEventListener('click', closeInputChoiceModal);

        textPromptSubmitBtn.addEventListener('click', () => {
            const userText = textPromptInput.value;
            if (userText.trim()) {
                closeTextPromptModal();
                generateScheduleWithGemini(userText, currentAiActionType);
            }
        });
        textPromptCancelBtn.addEventListener('click', closeTextPromptModal);
        textPromptCloseBtn.addEventListener('click', closeTextPromptModal);

        taskColumn.addEventListener('scroll', () => {
            clearTimeout(autoScrollTimerId);
            autoScrollTimerId = setTimeout(() => centerOnActiveTask(false), AUTO_SCROLL_DELAY);
            requestAnimationFrame(drawUnifiedTaskShapes); 
        });

        window.addEventListener('resize', () => {
            setAppHeight();
        });

        // --- √âcouteurs Supabase & UI ---
        loginSubmitBtn.addEventListener('click', handleSignIn);
        signupSubmitBtn.addEventListener('click', handleSignUp);
        showSignupBtn.addEventListener('click', showSignupForm);
        showLoginBtn.addEventListener('click', showLoginForm);
        userProfileBtn.addEventListener('click', toggleProfile);
        logoutButton.addEventListener('click', handleSignOut);
        toggleJsonEditorBtn.addEventListener('click', toggleJsonEditor);

        supabaseClient.auth.onAuthStateChange((event, session) => {
            updateAuthState(session);
        });

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
